<!DOCTYPE html>
<html>
<head>
    <title>OMDB - Movie</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1 id="movieTitle"></h1>
    <p id="movieDesc"></p>
    <p>Release Year: <span id="movieYear"></span></p>
    <p>Average Rating: <span id="movieRating"></span> ⭐</p>

    <h2>Reviews</h2>
    <div id="reviews"></div>

    <h3>Add Review</h3>
    <form id="reviewForm">
        <input type="number" id="rating" placeholder="Rating 1-5" min="1" max="5" required><br>
        <textarea id="comment" placeholder="Comment" required></textarea><br>
        <button type="submit">Submit Review</button>
    </form>

    <script>
        const params = new URLSearchParams(window.location.search);
        const movieId = params.get('id');

        const titleEl = document.getElementById('movieTitle');
        const descEl = document.getElementById('movieDesc');
        const yearEl = document.getElementById('movieYear');
        const ratingEl = document.getElementById('movieRating');
        const reviewsDiv = document.getElementById('reviews');
        const reviewForm = document.getElementById('reviewForm');

        function fetchMovie(){
            fetch(`http://localhost:8000/api/movies`)
            .then(res=>res.json())
            .then(data=>{
                const movie = data.find(m=>m.id==movieId);
                if(movie){
                    titleEl.innerText = movie.title;
                    descEl.innerText = movie.description;
                    yearEl.innerText = movie.release_year;
                    ratingEl.innerText = movie.average_rating.toFixed(1);
                }
            });
        }

        function fetchReviews(){
            fetch(`http://localhost:8000/api/movies/${movieId}/reviews`)
            .then(res=>res.json())
            .then(data=>{
                reviewsDiv.innerHTML='';
                data.forEach(r=>{
                    const div = document.createElement('div');
                    div.innerHTML = `<p>Rating: ${r.rating} ⭐</p><p>${r.comment}</p><hr>`;
                    reviewsDiv.appendChild(div);
                });
            });
        }

        reviewForm.addEventListener('submit',(e)=>{
            e.preventDefault();
            const rating = document.getElementById('rating').value;
            const comment = document.getElementById('comment').value;
            const token = localStorage.getItem('token');

            fetch(`http://localhost:8000/api/movies/${movieId}/reviews`,{
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({rating, comment})
            })
            .then(res=>res.json())
            .then(data=>{
                alert(data.msg);
                fetchReviews();
                fetchMovie();
            });
        });

        fetchMovie();
        fetchReviews();
    </script>
</body>
</html>
